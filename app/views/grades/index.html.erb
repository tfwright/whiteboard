<style>
  .student {
    min-width:100px;
    border-right:dotted 1px black;
  }
  th {
    padding: 0 5px;
  }
  .editable {
    min-width:60px;
    text-align:center;
  }
  .editable:hover {
    background-color:yellow;
  }
  tr {
    height:40px;
  }
</style>
<script>
  function hideGradeForm(el, score){
    $(el).hide();
    $("input", el).unbind("blur");
    $("input", el).blur();
    $("span.grade", $(el).parents("td")).text(score);
    $("span.grade", $(el).parents("td")).show();
  }
  
  function showGradeForm(el){
    $("span", el).hide();
    $("form", el).show();
    $("input", el).focus();
    $("input", el).blur(function(event){
      $("form", el).submit();
    });
  }
  
  function newGradeSuccessHandler(event, grade, status) {
    var gradeJSON = $.parseJSON(grade)
    hideGradeForm(event.target, gradeJSON.score);
    $(event.target).attr("action", gradeJSON.update_url)
    $(event.target).attr("method", "put")
    $("input[type=hidden]", event.target).remove();
    $(event.target).unbind("ajax:success")
    $(event.target).bind("ajax:success", updateGradeSuccessHandler);
  };

  function updateGradeSuccessHandler(event, grade, status){
    hideGradeForm(event.target, $.parseJSON(grade).score);
  };
  
  $(document).ready(function() {
    $("form").hide();
    $("td.editable").each(function(i, el){
      $(el).click(function(event){
        showGradeForm(el);
      });
      if($("span.grade", el).text() == "--") { 
        $("form", el).bind("ajax:success", newGradeSuccessHandler);
      } else {
        $("form", el).bind("ajax:success", updateGradeSuccessHandler);
      };
      $("form", el).bind("ajax:failure", function(event, grade, status){
        alert("There was an error: " + grade.responseText);
      });
    });
  });
  
</script>
<%= render :partial => "courses/header" %>
<div style="width:100%;overflow-x:auto">
  <table>
    <tr>
      <th class="student">Student</th>
      <% @current_course.assignments.each do |assignment| %>
        <th title="<%= assignment.name %>"><%= truncate(assignment.name, :length => 8) %></th>
      <% end %>
    </tr>
    <% @students.each do |student| %>
      <tr>
        <td class="student"><%= student.name %></td>
        <% @current_course.assignments.each do |assignment| %>
          <td id="student-<%= student.id %>-assign-<%= assignment.id %>" class="editable">
              <% if grade = student.grades.first(:conditions => {:assignment_id => assignment.id}) %>
                <span class="grade"><%= grade.score %></span>
                <%= form_for(grade, :url => course_grade_path(@current_course, grade, :format => :js), :remote => true) do |f| %>
                  <%= f.text_field :score, :size => 3, :style => "width:auto" %>
                <% end %>
              <% else %>
                <span class="grade">--</span>
                <%= form_for(Grade.new, :url => course_grades_path(@current_course, :format => :js), :remote => true) do |f| %>
                  <%= f.text_field :score, :size => 3, :style => "width:auto" %>
                  <%= f.hidden_field :assignment_id, :value => assignment.id %>
                  <%= f.hidden_field :student_id, :value => student.id %>
                <% end %>
              <% end %>
          </td>
        <% end %>
      </tr>
    <% end %>
  </table>
</div>